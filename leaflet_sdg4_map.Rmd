---
title: "leaflet_sdg4_map"
author: "Sperow, KC (Kasan)"
date: "11/26/2021"
output:
  html_document: default
  pdf_document: default
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r include=FALSE, echo=FALSE}
library(tidyverse)
library(ggthemes)
```

# Data Cleaning from Start to Finish as of Nov 26
1. Original import to be all columns since after linear modeling, I thought I might need to go back and add in the insitutional dimension. 
2. SDG 4 with 12 other relevant variables 
3. Data cleaning
4. Join with polygon column for leaflet layer.
5. Join with latitude, longitude for popup interactive layer

# Original Data File: SPI Data.csv
```{r}
# Reading in Original File from the World Bank's
# Statistical Performance Indicators Data
spi_data <- read_csv("./zipped_folder/data/SPI Data.csv")
#glimpse(spi_data)
```


# SDG 4 Columns Only:
```{r}
# picking columns: sdg plus 12
spi_edu <- read_csv("./zipped_folder/data/SPI Data.csv", 
                    col_types = cols_only(country = col_factor(),
                                          region = col_factor(), 
                                          iso3c = col_factor(), 
                                          date = col_double(),
                                          income = col_factor(),
                                          SPI.INDEX.PIL3 = col_double(),
                                          SPI.INDEX.PIL4 = col_double(),
                                          SPI.INDEX = col_double(),
                                          SPI.DIM3.1.INDEX = col_double(),
                                          SPI.DIM4.2.INDEX = col_double(),
                                          SPI.D3.4.EDUC = col_double(),
                                          weights = col_number(),
                                          population = col_number()))
```

```{r}
str(spi_edu)
problems(spi_edu)
```

```{r}
# Initial cleaning and renaming
spi_edu %>% 
  filter(!is.na(date)) %>% # takes out first row from 3489 original rows
  rename(pill_3 = SPI.INDEX.PIL3,
         pill_4 = SPI.INDEX.PIL4,
         spi_index = SPI.INDEX,
         dim_3_1 = SPI.DIM3.1.INDEX,
         dim_4_2 = SPI.DIM4.2.INDEX,
         sdg_4 = SPI.D3.4.EDUC,
         Income = income,
         Region = region) %>% 
  relocate(sdg_4, .after = date) -> spi_edu
```


```{r}
head(spi_edu)
```

```{r}
nrow(spi_edu)
```

## Overview of Columns & Column Types:
```{r}
# column types
spi_edu %>% 
  summarize(across(everything(), class)) %>% 
  pivot_longer(cols = everything(),
               names_to = "col_name", 
               values_to = "col_type") %>% 
  arrange(col_type) 
```


### Checking Levels of Income & Region:

- Income
```{r}
# checking levels of Income
levels(spi_edu$Income)

# fixing blank "" income level
# per this output, it seems that they all add up to 3488
spi_edu %>% 
  group_by(Income) %>% 
  summarize(count_per_income = n())

spi_edu %>% 
  filter(Income==" ")

spi_edu %>% 
  filter(is.na(Income))
```

- Region

```{r}
# showing levels of region
levels(spi_edu$Region)

# checking for NA values
spi_edu %>% 
  filter(is.na(Region))

# showing number of records per region
spi_edu %>% 
  group_by(Region) %>% 
  summarize(count_per_region = n())
# this adds up to 3488, so it looks as tho i don't need to recode levels.
```

# How many countries in each region?
- This will be important later for seeing which countries within a region may or may not carry the most weight. 
```{r}
# how many countries in each region?
#  there are 7 regions
spi_edu %>% 
  group_by(Region) %>% # 218 groups
  summarize(Region, country) %>% 
  unique() %>% 
  summarize(count_per_region = n()) %>% 
  arrange(-count_per_region) %>% 
  mutate(Region = fct_infreq(Region))

```


```{r}
levels(spi_edu$Region)
class(spi_edu$Region)
```


```{r}
# are there NA values for sdg 4 ?
spi_edu %>% 
  filter(is.na(sdg_4)) %>% 
  group_by(country) %>% 
  summarize(count_NA = n())

```
- Observation:  There is no SDG 4 data for the Channel Islands, Kosovo, or Taiwan for the 16 years of data collected by the World Bank (2004-2019). 
- Conclusion: **Need to filter out the NA values for these 3 countries and save back to the df.**
- Assumption: For the scope of this project, it is ok if we can simply do *most* countries. Many/most have at least some values for SDG 4 later within the 16 year period, but these countries have none at all for all 16 years.

```{r}
spi_edu %>% 
  filter(!is.na(sdg_4)) -> spi_edu
```


# JOINS FOR LEAFLET INTERACTIVE MAP

- My first try had an SDG 4 value for the US at 0, so I didn't have the data filtered correctly; however, now you will see below that I go through a process of more cleaning and some calculations in order to be able to show a growth rate of SDG 4 score over time on the pop-up map: 

1. JOIN with Spatial Data Columns: lat, long, geometry point, geometry multipolygon:

- See data in ./zipped_foler/data for the files imported below:

```{r include=FALSE, echo=FALSE}
library(sf)
library(leaflet)
library(viridis)
```


```{r}
# REVISED nov 26: need esri folder for polygons to layer on top of tiles
# then use LL to layer the popup data

# # importing ESRI folder with spatial data for country boundaries
world_boundaries <- read_sf("./zipped_folder/data/World_Countries_(Generalized)")
#head(world_boundaries)

world_boundaries %>% 
  rename(iso2c = ISO) -> world_boundaries

world_boundaries %>% head() # use this one for polygon highlights layer
```


```{r}
# need this import bc it has lat, long for creating the point column later
# for the popup

# for popup labels - do not need esri polygon
# need LL columns for generating point in center of each country
world_LL <- read_csv("./zipped_folder/data/world_country_and_usa_states_latitude_and_longitude_values.csv")


world_LL %>% 
  select(country_code, latitude, longitude, country) %>% 
  rename(iso2 = country_code) %>% 
  relocate(country, .after=iso2)-> world_LL

head(world_LL)
```

```{r}
#glimpse(world_boundaries)
```

- need to rename COUNTRY as ```country```
```{r}
# renaming country column and saving back to dataframe
# world_boundaries %>% 
#   rename(country = COUNTRY, iso2=ISO) -> world_boundaries
# 
# str(world_boundaries)
```

## for mapping, I would like to show the SDG 4 score and the percent change over time from 2004 - 2019 (before joining with spatial columns):

```{r}
spi_edu %>% head()
```

# these separate variables are for graphing the change in SDG4 performance pre-pandemic over time for all countries.
```{r}
spi_edu %>% 
  filter(date==2004) %>% 
  rename(sdg_score_2004 = sdg_4) %>% 
  select(country, iso3c, date, sdg_score_2004)-> sdg4_2004 # 215 rows
sdg4_2004

spi_edu %>% filter(date==2019) %>% 
  rename(sdg_score_2019 = sdg_4) %>% 
  select(country, iso3c, date, sdg_score_2019) %>% 
  arrange(country)-> sdg4_2019 # 215 rows
sdg4_2019
```

# need a percent change in sdg4 score from 2004 to 2019:
```{r}
# the join was messing up the sdg values because it was overwriting some
# from the date column
sdg4_2004 %>% full_join(sdg4_2019, by= c("iso3c"="iso3c")) %>% 
  select(country.x, iso3c, sdg_score_2004, sdg_score_2019) %>% 
  rename(country = country.x) %>% 
  mutate(point_diff = sdg_score_2019 - sdg_score_2004) %>% 
 # mutate(perc_change = (point_diff/sdg_score_2004)*100) %>% 
  # mutate(perc_change = case_when(perc_change==Inf ~ "No change",
  #                                perc_change==NaN ~ "Still 0"
  mutate(growth_rate = (point_diff-sdg_score_2004)/1*100) ->sdg_df

sdg_df
```

# need sf df for creating map layer
```{r}
class(world_LL)
```

```{r echo=FALSE}
# need to create map layer with popup from LL and project data
######  sdg_df has iso3c as colum
######  world_LL has iso with 2 characters as column

##----->>>>> need intermediary between ISO 2 and 3 character 
# bc country names may not be consistent

# need import of ISO codes with both 2 and 3 character:
un_iso_codes <- read_csv("./zipped_folder/data/UNSD â€” Methodology.csv")
# may need to ask Dr. Ressler about if this whole row was left out or 
# maybe if it threw off other rows? 
# is this because of maybe some subrows with subtitles?
#problems(un_iso_codes)

# checking data randomly
# un_iso_codes%>% 
#   slice_sample(n=100)

un_iso_codes %>% glimpse()
```

```{r}
un_iso_codes %>% 
  rename(iso2 = `ISO-alpha2 Code`,
         iso3c = `ISO-alpha3 Code`,
         un_country_name_area = `Country or Area`) %>% 
  relocate(iso2, iso3c, un_country_name_area) %>%  # with no other arguments, it auto moves to front
  select(iso2, iso3c, un_country_name_area) %>% 
  group_by(un_country_name_area) %>% 
  summarize(iso2, iso3c, un_country_name_area) -> iso_codes

head(iso_codes)
```

# NEED TO JOIN sdg4 values with percent increase to LL via iso2/3 conversion:

```{r}
colnames(iso_codes)
```
```{r}
colnames(sdg_df)
```

```{r}
colnames(world_LL)
```


```{r}
sdg_df %>% 
  left_join(iso_codes, by=c("iso3c"="iso3c")) %>% 
  left_join(world_LL, by=c("iso2" = "iso2")) %>% 
  dplyr::select(1:6, iso2, latitude, longitude) %>% 
  relocate(iso2, .after = iso3c) %>% 
  rename(country = country.x) -> sdg_map_layer_nov26

head(sdg_map_layer_nov26)
class(sdg_map_layer_nov26)

# need to convert to sf object
sdg_map_layer_nov26 %>% 
  filter(!is.na(latitude) | !is.na(longitude)) %>%  # 211 rows
  mutate(popup_label = paste(paste0('<b>Country: ', country, '</b>'),
                             paste0('<b>2019 SDG 4 Score: ', sdg_score_2019, '</b>'),
                             paste0('Percent Change Since 2004: ', round(growth_rate,1), "%"), 
                             sep = '<br/>')) %>% 
  st_as_sf(coords = c("longitude", "latitude"), 
           crs = 4326, agr = "field") -> sdg_map_layer_nov26

sdg_map_layer_nov26 %>% filter(country=="Paraguay")
```


# Build Map

```{r}
pal2 <- colorNumeric(
  palette = "RdBu",
  domain = sdg_map_layer_nov26$growth_rate
)

# mapping per class notes 
leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = world_boundaries,
              color = 'white', # outline of the polygon countries
              weight = 1.5,
              opacity = 1,
              fillColor = "#e8e8e8", # very light gray 
              fillOpacity = .8,
              highlightOptions = highlightOptions(color = "#FFF1BE", # yellow 
                                                  weight = 5)) %>% 
  addCircleMarkers(data = sdg_map_layer_nov26,
                   popup = ~popup_label,
                   stroke=F,
                   radius = 4,
                   fillColor = ~pal2(growth_rate),
                   fillOpacity = 1)
```



```{r}
# fixed some popup labels creating repeating decimals for some reason
# becuase the growth_rate column did not have more than 1 decimal point.
# didn't need to round() in palette bc that did not change popup labels
# so I went into popup label cration mutate() and put round()
pal2 <- colorNumeric(
  palette = "viridis",
  domain = sdg_map_layer_nov26$growth_rate
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = world_boundaries,
              color = 'white', # outline of the polygon countries
              weight = 1.5,
              opacity = 1,
              fillColor = ~pal2(sdg_map_layer_nov26$growth_rate), 
              fillOpacity = .8,
              highlightOptions = highlightOptions(color = "#FFF1BE", # yellow 
                                                  weight = 5)) %>% 
  addCircleMarkers(data = sdg_map_layer_nov26,
                   popup = ~popup_label,
                   stroke=F,
                   radius = 4,
                   fillColor = "gray",
                   fillOpacity = 1)
```


- gradient for Max: income or region with hope of showing what he needs to decide
- report PDF with slides in HTML


jan 2022: if I want to save as an html/png/pdf/jpeg file:
```{r}

# mapshot(
#   x,
#   url = NULL,
#   file = NULL,
#   remove_controls = c("zoomControl", "layersControl", "homeButton", "scaleBar",
#     "drawToolbar", "easyButton"),
#   ...
# )

```

